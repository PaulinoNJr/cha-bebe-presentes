<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lista de Presentes - Chá da Melissa (Mel)</title>

  <!-- Bootswatch (Bootstrap 5) - Minty -->
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/minty/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --mel-bg: #fff8fb;
      --mel-pink: #ff8db1;
      --mel-pink-dark: #ef5f8d;
      --mel-blue: #8ed9ff;
      --mel-yellow: #ffd875;
      --mel-text: #634f63;
      --mel-card: #ffffff;
      --mel-border: #ffd7e5;
    }
    body {
      font-family: "Nunito", sans-serif;
      color: var(--mel-text);
      background:
        radial-gradient(circle at 12% 8%, #ffe5ee 0, #ffe5ee 8%, transparent 9%),
        radial-gradient(circle at 90% 14%, #e5f7ff 0, #e5f7ff 7%, transparent 8%),
        radial-gradient(circle at 80% 85%, #fff0c6 0, #fff0c6 10%, transparent 11%),
        linear-gradient(180deg, #fffafc 0%, #fff6ef 100%);
      background-attachment: fixed;
    }
    .sticky-actions {
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom: 0;
      background: linear-gradient(95deg, #ffd8e6 0%, #ffeec0 55%, #d9f2ff 100%);
      box-shadow: 0 8px 24px rgba(146, 115, 146, 0.15);
    }
    .sticky-actions .container {
      padding-top: 1rem;
      padding-bottom: 1rem;
    }
    .brand-title {
      font-family: "Baloo 2", cursive;
      font-size: clamp(1.5rem, 2vw, 2rem);
      line-height: 1.05;
      color: #a65478;
      margin-bottom: 0.2rem;
    }
    .brand-subtitle {
      color: #7f6980;
      font-weight: 600;
      font-size: 0.92rem;
      max-width: 560px;
    }
    .chip-love {
      display: inline-block;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.72);
      border: 1px solid #ffd6e4;
      padding: 0.2rem 0.7rem;
      font-size: 0.78rem;
      font-weight: 700;
      color: #a65478;
      margin-bottom: 0.35rem;
    }
    .filter-ribbon {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid #ffe0ea;
      border-radius: 16px;
      padding: 0.7rem 0.85rem;
      box-shadow: 0 8px 20px rgba(176, 146, 172, 0.12);
    }
    .gift-img {
      width: 100%;
      aspect-ratio: 1 / 1;
      max-height: 320px;
      object-fit: contain;
      background: linear-gradient(160deg, #fff8f3, #f7fcff);
      padding: 12px;
      border-bottom: 1px dashed #f0d9e5;
    }
    .card {
      border: 1px solid var(--mel-border);
      border-radius: 24px;
      background: var(--mel-card);
      box-shadow: 0 12px 26px rgba(177, 143, 177, 0.14);
      overflow: hidden;
    }
    .card-title {
      font-family: "Baloo 2", cursive;
      color: #93476c;
      letter-spacing: 0.2px;
    }
    .list-group-item {
      border-color: #f9e4ec;
    }
    .res-list { max-height: 160px; overflow: auto; border-radius: 12px; }
    .alert {
      border-radius: 14px;
      border: 1px solid #f2dce7;
    }
    .btn {
      border-radius: 14px;
      font-weight: 700;
    }
    .btn-primary {
      background: linear-gradient(180deg, var(--mel-pink), var(--mel-pink-dark));
      border-color: #e85f8b;
      box-shadow: 0 6px 14px rgba(239, 95, 141, 0.25);
    }
    .btn-primary:hover {
      background: linear-gradient(180deg, #ff78a3, #e25383);
      border-color: #de4f7d;
    }
    .btn-outline-primary {
      color: #965774;
      border-color: #eba8c2;
      background: #fff8fb;
    }
    .btn-outline-primary:hover {
      color: #fff;
      background: #e878a1;
      border-color: #e878a1;
    }
    .btn-warning {
      background: linear-gradient(180deg, #ffe58c, #ffd067);
      border-color: #f4c85b;
      color: #7c5b1a;
    }
    .btn-warning:hover {
      background: linear-gradient(180deg, #ffdc74, #fbc650);
      border-color: #f2bc47;
      color: #6c4f19;
    }
    .badge.text-bg-success {
      background-color: #8ac25d !important;
    }
    .badge.text-bg-danger {
      background-color: #f16f89 !important;
    }
    .whats-fab {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 1200;
      width: 58px;
      height: 58px;
      border-radius: 50%;
      border: 0;
      background: #25d366;
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      text-decoration: none;
    }
    .whats-fab:hover {
      background: #1fb85a;
      color: #fff;
    }
    @media (max-width: 768px) {
      .sticky-actions .container {
        padding-top: 0.8rem;
        padding-bottom: 0.8rem;
      }
      .filter-ribbon {
        padding: 0.65rem 0.75rem;
      }
    }
  </style>
</head>
<body class="bg-light">
  <div class="sticky-actions border-bottom">
    <div class="container py-3 d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <div>
        <span class="chip-love">Com carinho para a Mel</span>
        <h1 class="brand-title">Chá da Melissa (Mel)</h1>
        <div class="brand-subtitle">Escolha um item, informe seu nome e quantidade. Cada gesto de carinho é especial para nossa pequena.</div>
      </div>
      <div class="d-flex gap-2 flex-wrap align-items-center">
        <button id="refreshBtn" class="btn btn-outline-primary btn-sm">Atualizar</button>
        <a href="./admin.html" class="btn btn-warning btn-sm">Admin</a>
      </div>
    </div>
  </div>

  <div class="container pt-3 pb-1">
    <div id="instructionsBox" class="alert alert-warning d-none mb-0"></div>
  </div>

  <div class="container py-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2 filter-ribbon">
      <label for="classFilter" class="small text-muted mb-0">Filtrar por categoria:</label>
      <select id="classFilter" class="form-select form-select-sm" style="max-width: 320px;">
        <option value="">Todas as classificações</option>
      </select>
    </div>
    <div id="status" class="alert alert-secondary py-2 small">Carregando...</div>
    <div id="grid" class="row g-3"></div>
    <div class="text-muted small mt-3">
      Dica: se a quantidade acabar enquanto você reserva, o sistema bloqueia automaticamente.
    </div>
  </div>

  <a
    class="whats-fab"
    href="https://wa.me/5519997591102"
    target="_blank"
    rel="noopener noreferrer"
    aria-label="Conversar no WhatsApp"
    title="Falar no WhatsApp"
  >
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="30" height="30" aria-hidden="true">
      <path fill="currentColor" d="M16 3C8.8 3 3 8.7 3 15.9c0 2.3.6 4.5 1.8 6.4L3 29l6.9-1.8c1.8 1 3.9 1.6 6.1 1.6 7.2 0 13-5.7 13-12.9S23.2 3 16 3zm0 23.5c-2 0-3.9-.5-5.6-1.5l-.4-.2-4.1 1.1 1.1-4-.3-.4C5.6 19.8 5 17.9 5 15.9 5 9.9 9.9 5 16 5s11 4.9 11 10.9-4.9 10.6-11 10.6zm6.1-7.9c-.3-.1-1.9-.9-2.2-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1-1.8-.9-3-1.7-4.2-3.8-.3-.5.3-.5.8-1.6.1-.2.1-.4 0-.5-.1-.1-.7-1.7-1-2.3-.3-.7-.6-.6-.8-.6h-.7c-.2 0-.5.1-.7.3-.2.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.2 4.9 4.4.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.5-.1 1.9-.8 2.1-1.6.3-.8.3-1.5.2-1.6-.1-.1-.3-.2-.6-.3z"/>
    </svg>
  </a>

  <!-- Modal Reserva -->
  <div class="modal fade" id="reserveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Reservar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div id="modalDesc" class="text-muted small mb-2"></div>

          <div class="mb-3">
            <label class="form-label">Seu nome</label>
            <input id="nameInput" class="form-control" placeholder="Ex: Ana Souza" maxlength="80">
            <div class="form-text">Use nome e sobrenome (evita duplicidade).</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Quantidade</label>
            <select id="qtySelect" class="form-select"></select>
            <div class="form-text" id="qtyHelp"></div>
          </div>

          <div id="modalAlert" class="alert d-none mb-0" role="alert"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="confirmBtn" class="btn btn-primary">Confirmar reserva</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="./supabase-config.js"></script>

  <script type="module">
    const cfg = window.SUPABASE_CONFIG || {};
    const SUPABASE_URL = cfg.url;
    const SUPABASE_ANON_KEY = cfg.anonKey;

    async function sbFetch(path, { method="GET", body=null } = {}) {
      const res = await fetch(`${SUPABASE_URL}${path}`, {
        method,
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: body ? JSON.stringify(body) : null,
      });

      const txt = await res.text();
      let data;
      try { data = txt ? JSON.parse(txt) : null; } catch { data = txt; }

      if (!res.ok) {
        const msg = (data && (data.message || data.error || data.hint)) ? (data.message || data.error || data.hint) : `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    const grid = document.getElementById("grid");
    const status = document.getElementById("status");
    const refreshBtn = document.getElementById("refreshBtn");
    const classFilter = document.getElementById("classFilter");
    const instructionsBox = document.getElementById("instructionsBox");

    const missingConfig =
      !SUPABASE_URL ||
      !SUPABASE_ANON_KEY ||
      SUPABASE_URL.includes("SEU-PROJETO") ||
      SUPABASE_ANON_KEY.includes("SUA_ANON_KEY");

    if (missingConfig) {
      status.className = "alert alert-danger py-2 small";
      status.innerHTML = 'Configure <code>supabase-config.js</code> com <code>url</code> e <code>anonKey</code> do Supabase.';
      throw new Error("Supabase não configurado.");
    }

    const modalEl = document.getElementById("reserveModal");
    const reserveModal = new bootstrap.Modal(modalEl);
    const modalTitle = document.getElementById("modalTitle");
    const modalDesc = document.getElementById("modalDesc");
    const nameInput = document.getElementById("nameInput");
    const qtySelect = document.getElementById("qtySelect");
    const qtyHelp = document.getElementById("qtyHelp");
    const confirmBtn = document.getElementById("confirmBtn");
    const modalAlert = document.getElementById("modalAlert");

    let classifications = [];
    let gifts = [];
    let reservations = [];
    let currentGift = null;

    const esc = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
    const upper = (s) => String(s ?? "").toLocaleUpperCase("pt-BR");
    const formatBRL = (v) => (v === null || v === undefined || v === "")
      ? "Valor não informado"
      : new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(Number(v));

    function sanitizeHtml(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(String(html ?? ""), "text/html");
      doc.querySelectorAll("script,style,iframe,object").forEach(el => el.remove());
      doc.querySelectorAll("*").forEach(el => {
        [...el.attributes].forEach(attr => {
          if (/^on/i.test(attr.name)) el.removeAttribute(attr.name);
        });
      });
      return doc.body.innerHTML;
    }

    function setModalAlert(kind, msg) {
      modalAlert.classList.remove("d-none", "alert-danger", "alert-success", "alert-warning", "alert-info");
      modalAlert.classList.add(`alert-${kind}`);
      modalAlert.textContent = msg;
    }
    const clearModalAlert = () => { modalAlert.className = "alert d-none mb-0"; modalAlert.textContent = ""; };

    function reservationsForGift(giftId) {
      return reservations.filter(r => r.gift_id === giftId)
        .sort((a,b) => new Date(b.reserved_at) - new Date(a.reserved_at));
    }

    function renderFilterOptions() {
      const selected = classFilter.value;
      classFilter.innerHTML =
        `<option value="">Todas as classificações</option>` +
        classifications.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join("");

      if (selected && classifications.some(c => String(c.id) === selected)) {
        classFilter.value = selected;
      } else {
        classFilter.value = "";
      }
    }

    function renderInstructions(siteContent) {
      const html = siteContent?.instructions_html?.trim() || "";
      if (!html) {
        instructionsBox.classList.add("d-none");
        instructionsBox.innerHTML = "";
        return;
      }
      instructionsBox.innerHTML = sanitizeHtml(html);
      instructionsBox.classList.remove("d-none");
    }

    function getFilteredGifts() {
      const selected = classFilter.value;
      if (!selected) return gifts;
      return gifts.filter(g => String(g.classification_id ?? "") === selected);
    }

    function giftCard(g) {
      const isFull = g.qty_available <= 0;

      const img = g.image_url
        ? `<img src="${esc(g.image_url)}" class="card-img-top gift-img" alt="${esc(g.title)}">`
        : `<div class="bg-secondary-subtle d-flex align-items-center justify-content-center gift-img"><span class="text-muted small">Sem imagem</span></div>`;

      const buyBtn = g.buy_url
        ? `<a class="btn btn-sm btn-outline-secondary" href="${esc(g.buy_url)}" target="_blank" rel="noopener">Comprar</a>`
        : `<span class="text-muted small">Sem link</span>`;

      const reserveBtn = isFull
        ? `<button class="btn btn-sm btn-secondary" disabled>Esgotado</button>`
        : `<button class="btn btn-sm btn-primary" data-id="${g.id}">Reservar</button>`;

      const badge = isFull
        ? `<span class="badge text-bg-danger">Esgotado</span>`
        : `<span class="badge text-bg-success">Disponível: ${g.qty_available} / ${g.qty_total}</span>`;

      const res = reservationsForGift(g.id);
      const resHtml = res.length
        ? res.map(x => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>${esc(x.reserved_by)}</span>
              <span class="badge text-bg-light">x${x.qty}</span>
            </li>`).join("")
        : `<li class="list-group-item text-muted small">Nenhuma reserva ainda.</li>`;

      return `
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card shadow-sm h-100">
            ${img}
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <h5 class="card-title mb-0">${esc(upper(g.title))}</h5>
                ${badge}
              </div>
              <div class="small text-muted mt-1">${esc(g.classification_name || "Sem classificação")}</div>
              <div class="small fw-semibold mt-1">${esc(formatBRL(g.price_value))}</div>
              <p class="card-text text-muted small mt-2">${esc(g.description || "")}</p>

              <div class="d-flex flex-wrap gap-2 mt-auto pt-2">
                ${buyBtn}
                ${reserveBtn}
              </div>

              <div class="mt-3">
                <div class="fw-semibold small mb-2">Reservado por</div>
                <ul class="list-group res-list">${resHtml}</ul>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderGrid() {
      const filtered = getFilteredGifts();
      const full = filtered.filter(g => g.qty_available <= 0).length;
      const selectedText = classFilter.options[classFilter.selectedIndex]?.text || "Todas as classificações";

      status.className = "alert alert-light border py-2 small";
      status.textContent = `Filtro: ${selectedText} | Exibindo: ${filtered.length} de ${gifts.length} | Disponíveis: ${filtered.length - full} | Esgotados: ${full}`;

      if (!filtered.length) {
        grid.innerHTML = `<div class="col-12"><div class="alert alert-warning py-2 small mb-0">Nenhum item nesta classificação.</div></div>`;
        return;
      }

      grid.innerHTML = filtered.map(giftCard).join("");

      grid.querySelectorAll("button.btn-primary[data-id]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = Number(btn.getAttribute("data-id"));
          const gift = gifts.find(x => x.id === id);
          openReserveModal(gift);
        });
      });
    }

    async function loadAll() {
      status.className = "alert alert-secondary py-2 small";
      status.textContent = "Carregando...";

      const siteContent = await sbFetch(`/rest/v1/site_content?select=instructions_html&id=eq.1&limit=1`);
      classifications = await sbFetch(`/rest/v1/gift_classifications?select=id,name&order=name.asc`);
      gifts = await sbFetch(`/rest/v1/gifts_view?select=id,title,description,image_url,buy_url,price_value,classification_id,classification_name,qty_total,qty_reserved,qty_available&order=id.asc`);
      reservations = await sbFetch(`/rest/v1/gift_reservations?select=gift_id,reserved_by,qty,reserved_at&order=reserved_at.desc`);

      renderInstructions(siteContent?.[0] || null);
      renderFilterOptions();
      renderGrid();
    }

    function openReserveModal(gift) {
      currentGift = gift;
      clearModalAlert();
      modalTitle.textContent = `Reservar: ${upper(gift.title)}`;
      modalDesc.textContent = gift.description || "";

      nameInput.value = "";

      qtySelect.innerHTML = "";
      const max = Math.max(0, gift.qty_available);
      for (let i = 1; i <= max; i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = String(i);
        qtySelect.appendChild(opt);
      }
      qtyHelp.textContent = `Disponível agora: ${gift.qty_available} de ${gift.qty_total}.`;

      confirmBtn.disabled = (max <= 0);
      reserveModal.show();
      setTimeout(() => nameInput.focus(), 150);
    }

    async function reserveGift(giftId, name, qty) {
      return sbFetch(`/rest/v1/rpc/reserve_gift`, {
        method: "POST",
        body: { p_gift_id: giftId, p_name: name, p_qty: qty }
      });
    }

    confirmBtn.addEventListener("click", async () => {
      clearModalAlert();
      if (!currentGift) return;

      const name = nameInput.value.trim();
      const qty = Number(qtySelect.value);

      // proteção mínima no front
      if (name.length < 3 || !name.includes(" ")) {
        setModalAlert("warning", "Informe nome e sobrenome (ex: Ana Souza).");
        return;
      }
      if (!Number.isFinite(qty) || qty <= 0) {
        setModalAlert("warning", "Escolha uma quantidade válida.");
        return;
      }

      confirmBtn.disabled = true;
      confirmBtn.textContent = "Reservando...";

      try {
        await reserveGift(currentGift.id, name, qty);
        setModalAlert("success", `Reserva confirmada: ${upper(currentGift.title)} (x${qty}) - ${name}`);
        await loadAll();
        setTimeout(() => reserveModal.hide(), 650);
      } catch (e) {
        const msg = String(e.message || "");
        if (msg.includes("NOT_ENOUGH_QTY")) setModalAlert("danger", "Quantidade insuficiente (alguém reservou antes). Atualize e tente novamente.");
        else if (msg.includes("INVALID_NAME")) setModalAlert("danger", "Nome inválido.");
        else if (msg.includes("INVALID_QTY")) setModalAlert("danger", "Quantidade inválida.");
        else setModalAlert("danger", `Erro: ${msg}`);
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = "Confirmar reserva";
      }
    });

    refreshBtn.addEventListener("click", loadAll);
    classFilter.addEventListener("change", renderGrid);
    setInterval(loadAll, 15000); // auto-refresh leve
    loadAll();
  </script>
</body>
</html>


