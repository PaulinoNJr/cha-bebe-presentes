<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lista de Presentes - Chá de Bebê</title>

  <!-- Bootswatch (Bootstrap 5) - Minty -->
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/minty/bootstrap.min.css" rel="stylesheet">

  <style>
    .gift-img { aspect-ratio: 16/9; object-fit: cover; }
    .res-list { max-height: 160px; overflow:auto; }
    .sticky-actions { position: sticky; top: 0; z-index: 10; backdrop-filter: blur(6px); }
  </style>
</head>
<body class="bg-light">
  <div class="sticky-actions bg-light border-bottom">
    <div class="container py-3 d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <div>
        <h1 class="h4 mb-1">Lista de Presentes</h1>
        <div class="text-muted small">Escolha um item, informe seu nome e quantidade. Reservas ficam públicas.</div>
      </div>
      <div class="d-flex gap-2">
        <button id="refreshBtn" class="btn btn-outline-primary btn-sm">Atualizar</button>
      </div>
    </div>
  </div>

  <div class="container py-3">
    <div id="status" class="alert alert-secondary py-2 small">Carregando...</div>
    <div id="grid" class="row g-3"></div>
    <div class="text-muted small mt-3">
      Dica: se a quantidade acabar enquanto você reserva, o sistema bloqueia automaticamente.
    </div>
  </div>

  <!-- Modal Reserva -->
  <div class="modal fade" id="reserveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Reservar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div id="modalDesc" class="text-muted small mb-2"></div>

          <div class="mb-3">
            <label class="form-label">Seu nome</label>
            <input id="nameInput" class="form-control" placeholder="Ex: Ana Souza" maxlength="80">
            <div class="form-text">Use nome e sobrenome (evita duplicidade).</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Quantidade</label>
            <select id="qtySelect" class="form-select"></select>
            <div class="form-text" id="qtyHelp"></div>
          </div>

          <div id="modalAlert" class="alert d-none mb-0" role="alert"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button id="confirmBtn" class="btn btn-primary">Confirmar reserva</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="./supabase-config.js"></script>

  <script type="module">
    const cfg = window.SUPABASE_CONFIG || {};
    const SUPABASE_URL = cfg.url;
    const SUPABASE_ANON_KEY = cfg.anonKey;

    async function sbFetch(path, { method="GET", body=null } = {}) {
      const res = await fetch(`${SUPABASE_URL}${path}`, {
        method,
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: body ? JSON.stringify(body) : null,
      });

      const txt = await res.text();
      let data;
      try { data = txt ? JSON.parse(txt) : null; } catch { data = txt; }

      if (!res.ok) {
        const msg = (data && (data.message || data.error || data.hint)) ? (data.message || data.error || data.hint) : `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    const grid = document.getElementById("grid");
    const status = document.getElementById("status");
    const refreshBtn = document.getElementById("refreshBtn");

    const missingConfig =
      !SUPABASE_URL ||
      !SUPABASE_ANON_KEY ||
      SUPABASE_URL.includes("SEU-PROJETO") ||
      SUPABASE_ANON_KEY.includes("SUA_ANON_KEY");

    if (missingConfig) {
      status.className = "alert alert-danger py-2 small";
      status.innerHTML = 'Configure <code>supabase-config.js</code> com <code>url</code> e <code>anonKey</code> do Supabase.';
      throw new Error("Supabase nao configurado.");
    }

    const modalEl = document.getElementById("reserveModal");
    const reserveModal = new bootstrap.Modal(modalEl);
    const modalTitle = document.getElementById("modalTitle");
    const modalDesc = document.getElementById("modalDesc");
    const nameInput = document.getElementById("nameInput");
    const qtySelect = document.getElementById("qtySelect");
    const qtyHelp = document.getElementById("qtyHelp");
    const confirmBtn = document.getElementById("confirmBtn");
    const modalAlert = document.getElementById("modalAlert");

    let gifts = [];
    let reservations = [];
    let currentGift = null;

    const esc = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));

    function setModalAlert(kind, msg) {
      modalAlert.classList.remove("d-none", "alert-danger", "alert-success", "alert-warning", "alert-info");
      modalAlert.classList.add(`alert-${kind}`);
      modalAlert.textContent = msg;
    }
    const clearModalAlert = () => { modalAlert.className = "alert d-none mb-0"; modalAlert.textContent = ""; };

    function reservationsForGift(giftId) {
      return reservations.filter(r => r.gift_id === giftId)
        .sort((a,b) => new Date(b.reserved_at) - new Date(a.reserved_at));
    }

    function giftCard(g) {
      const isFull = g.qty_available <= 0;

      const img = g.image_url
        ? `<img src="${esc(g.image_url)}" class="card-img-top gift-img" alt="${esc(g.title)}">`
        : `<div class="bg-secondary-subtle d-flex align-items-center justify-content-center gift-img"><span class="text-muted small">Sem imagem</span></div>`;

      const buyBtn = g.buy_url
        ? `<a class="btn btn-sm btn-outline-secondary" href="${esc(g.buy_url)}" target="_blank" rel="noopener">Comprar</a>`
        : `<span class="text-muted small">Sem link</span>`;

      const reserveBtn = isFull
        ? `<button class="btn btn-sm btn-secondary" disabled>Esgotado</button>`
        : `<button class="btn btn-sm btn-primary" data-id="${g.id}">Reservar</button>`;

      const badge = isFull
        ? `<span class="badge text-bg-danger">Esgotado</span>`
        : `<span class="badge text-bg-success">Disponível: ${g.qty_available} / ${g.qty_total}</span>`;

      const res = reservationsForGift(g.id);
      const resHtml = res.length
        ? res.map(x => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>${esc(x.reserved_by)}</span>
              <span class="badge text-bg-light">x${x.qty}</span>
            </li>`).join("")
        : `<li class="list-group-item text-muted small">Nenhuma reserva ainda.</li>`;

      return `
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card shadow-sm h-100">
            ${img}
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <h5 class="card-title mb-0">${esc(g.title)}</h5>
                ${badge}
              </div>
              <p class="card-text text-muted small mt-2">${esc(g.description || "")}</p>

              <div class="d-flex flex-wrap gap-2 mt-auto pt-2">
                ${buyBtn}
                ${reserveBtn}
              </div>

              <div class="mt-3">
                <div class="fw-semibold small mb-2">Reservado por</div>
                <ul class="list-group res-list">${resHtml}</ul>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function loadAll() {
      status.className = "alert alert-secondary py-2 small";
      status.textContent = "Carregando...";

      gifts = await sbFetch(`/rest/v1/gifts_view?select=id,title,description,image_url,buy_url,qty_total,qty_reserved,qty_available&order=id.asc`);
      reservations = await sbFetch(`/rest/v1/gift_reservations?select=gift_id,reserved_by,qty,reserved_at&order=reserved_at.desc`);

      const total = gifts.length;
      const full = gifts.filter(g => g.qty_available <= 0).length;
      status.className = "alert alert-light border py-2 small";
      status.textContent = `Itens: ${total} | Disponíveis: ${total - full} | Esgotados: ${full}`;

      grid.innerHTML = gifts.map(giftCard).join("");

      grid.querySelectorAll("button.btn-primary[data-id]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = Number(btn.getAttribute("data-id"));
          const gift = gifts.find(x => x.id === id);
          openReserveModal(gift);
        });
      });
    }

    function openReserveModal(gift) {
      currentGift = gift;
      clearModalAlert();
      modalTitle.textContent = `Reservar: ${gift.title}`;
      modalDesc.textContent = gift.description || "";

      nameInput.value = "";

      qtySelect.innerHTML = "";
      const max = Math.max(0, gift.qty_available);
      for (let i = 1; i <= max; i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = String(i);
        qtySelect.appendChild(opt);
      }
      qtyHelp.textContent = `Disponível agora: ${gift.qty_available} de ${gift.qty_total}.`;

      confirmBtn.disabled = (max <= 0);
      reserveModal.show();
      setTimeout(() => nameInput.focus(), 150);
    }

    async function reserveGift(giftId, name, qty) {
      return sbFetch(`/rest/v1/rpc/reserve_gift`, {
        method: "POST",
        body: { p_gift_id: giftId, p_name: name, p_qty: qty }
      });
    }

    confirmBtn.addEventListener("click", async () => {
      clearModalAlert();
      if (!currentGift) return;

      const name = nameInput.value.trim();
      const qty = Number(qtySelect.value);

      // proteção mínima no front
      if (name.length < 3 || !name.includes(" ")) {
        setModalAlert("warning", "Informe nome e sobrenome (ex: Ana Souza).");
        return;
      }
      if (!Number.isFinite(qty) || qty <= 0) {
        setModalAlert("warning", "Escolha uma quantidade válida.");
        return;
      }

      confirmBtn.disabled = true;
      confirmBtn.textContent = "Reservando...";

      try {
        await reserveGift(currentGift.id, name, qty);
        setModalAlert("success", `Reserva confirmada: ${currentGift.title} (x${qty}) - ${name}`);
        await loadAll();
        setTimeout(() => reserveModal.hide(), 650);
      } catch (e) {
        const msg = String(e.message || "");
        if (msg.includes("NOT_ENOUGH_QTY")) setModalAlert("danger", "Quantidade insuficiente (alguém reservou antes). Atualize e tente novamente.");
        else if (msg.includes("INVALID_NAME")) setModalAlert("danger", "Nome inválido.");
        else if (msg.includes("INVALID_QTY")) setModalAlert("danger", "Quantidade inválida.");
        else setModalAlert("danger", `Erro: ${msg}`);
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = "Confirmar reserva";
      }
    });

    refreshBtn.addEventListener("click", loadAll);
    setInterval(loadAll, 15000); // auto-refresh leve
    loadAll();
  </script>
</body>
</html>
