<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Chá da Melissa (Mel)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/minty/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --mel-bg: #fff9ef;
      --mel-accent: #f0a500;
      --mel-accent-dark: #c78200;
    }
    body {
      background:
        radial-gradient(circle at top right, #fff4da 0%, transparent 45%),
        radial-gradient(circle at bottom left, #ffe8bc 0%, transparent 42%),
        var(--mel-bg);
    }
    h1 { color: #8f5b00; }
    .card { border: 1px solid #f4d79e; }
    .btn-primary {
      background-color: var(--mel-accent);
      border-color: var(--mel-accent);
    }
    .btn-primary:hover {
      background-color: var(--mel-accent-dark);
      border-color: var(--mel-accent-dark);
    }
    .btn-outline-primary {
      color: #8f5b00;
      border-color: #dbad4d;
    }
    .btn-outline-primary:hover {
      color: #fff;
      background: #c28718;
      border-color: #c28718;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 mb-0">Admin - Chá da Melissa (Mel)</h1>
      <div class="d-flex gap-2">
        <a href="./index.html" class="btn btn-outline-primary btn-sm">Ver lista</a>
        <button id="logoutBtn" class="btn btn-outline-secondary btn-sm d-none">Sair</button>
      </div>
    </div>

    <!-- Login -->
    <div id="loginCard" class="card shadow-sm">
      <div class="card-body">
        <h2 class="h6">Login</h2>
        <div class="row g-2">
          <div class="col-md-5">
            <input id="email" class="form-control" placeholder="Email" />
          </div>
          <div class="col-md-5">
            <input id="password" class="form-control" type="password" placeholder="Senha" />
          </div>
          <div class="col-md-2 d-grid">
            <button id="loginBtn" class="btn btn-primary">Entrar</button>
          </div>
        </div>
        <div id="loginMsg" class="small text-muted mt-2"></div>
      </div>
    </div>

    <!-- Admin -->
    <div id="adminArea" class="d-none">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h2 class="h6">Mensagem do topo da página pública</h2>
          <div class="d-flex flex-wrap gap-2 mb-2">
            <button class="btn btn-outline-secondary btn-sm" type="button" data-format="bold"><b>B</b></button>
            <button class="btn btn-outline-secondary btn-sm" type="button" data-format="italic"><i>I</i></button>
            <button class="btn btn-outline-secondary btn-sm" type="button" data-format="underline"><u>U</u></button>
            <button class="btn btn-outline-secondary btn-sm" type="button" data-format="insertUnorderedList">Lista</button>
            <button class="btn btn-outline-secondary btn-sm" type="button" data-format="h3">Título</button>
            <button class="btn btn-outline-secondary btn-sm" type="button" id="addLinkBtn">Link</button>
            <button class="btn btn-outline-secondary btn-sm" type="button" data-format="removeFormat">Limpar</button>
          </div>
          <div id="instructionsEditor" class="form-control" contenteditable="true" style="min-height:120px;"></div>
          <div class="d-flex gap-2 mt-2">
            <button id="saveInstructionsBtn" class="btn btn-primary btn-sm" type="button">Salvar mensagem</button>
            <span id="instructionsMsg" class="small text-muted align-self-center"></span>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-lg-5">
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <h2 class="h6">Cadastro de Classificação</h2>

              <div class="input-group input-group-sm mb-2">
                <input id="className" class="form-control" placeholder="Ex: Higiene, Quarto, Roupas" />
                <button id="saveClassBtn" class="btn btn-outline-primary">Salvar</button>
              </div>
              <div id="classMsg" class="small text-muted mb-2"></div>

              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Classificação</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="classTbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6">Novo/Editar Presente</h2>

              <input type="hidden" id="giftId">

              <div class="mb-2">
                <label class="form-label">Classificação</label>
                <select id="classification_id" class="form-select">
                  <option value="">Sem classificação</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label">Título</label>
                <input id="title" class="form-control text-uppercase" placeholder="Ex: FRALDA P" />
              </div>

              <div class="mb-2">
                <label class="form-label">Descrição</label>
                <textarea id="description" class="form-control" rows="2"></textarea>
              </div>

              <div class="mb-2">
                <label class="form-label">Imagem (URL)</label>
                <input id="image_url" class="form-control" placeholder="https://..." />
              </div>

              <div class="mb-2">
                <label class="form-label">Link compra (URL)</label>
                <input id="buy_url" class="form-control" placeholder="https://..." />
              </div>

              <div class="mb-2">
                <label class="form-label">Valor (R$)</label>
                <div class="input-group">
                  <input id="price_value" class="form-control" placeholder="Auto pelo link (editável)" />
                  <button id="detectPriceBtn" class="btn btn-outline-secondary" type="button">Capturar valor</button>
                </div>
                <div class="form-text">Ao informar link de compra, tente capturar o valor.</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Quantidade total</label>
                <input id="qty_total" class="form-control" type="number" min="1" value="1" />
              </div>

              <div class="d-flex gap-2">
                <button id="saveGiftBtn" class="btn btn-primary">Salvar</button>
                <button id="clearBtn" class="btn btn-outline-secondary">Limpar</button>
              </div>

              <div id="adminMsg" class="small text-muted mt-2"></div>
            </div>
          </div>
        </div>

        <div class="col-lg-7">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h2 class="h6 mb-0">Presentes</h2>
                <button id="refreshBtn" class="btn btn-outline-primary btn-sm">Atualizar</button>
              </div>

              <div class="table-responsive mt-3">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Título</th>
                      <th>Classificação</th>
                      <th>Valor</th>
                      <th>Total</th>
                      <th>Reservado</th>
                      <th>Disponível</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="giftsTbody"></tbody>
                </table>
              </div>

              <hr />

              <h3 class="h6">Reservas (para correção)</h3>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Presente</th>
                      <th>Nome</th>
                      <th>Qtd</th>
                      <th>Data</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="resTbody"></tbody>
                </table>
              </div>

              <div id="resMsg" class="small text-muted"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="./supabase-config.js"></script>

  <!-- supabase-js via ESM CDN -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const cfg = window.SUPABASE_CONFIG || {};
    const SUPABASE_URL = cfg.url;
    const SUPABASE_ANON_KEY = cfg.anonKey;

    const missingConfig =
      !SUPABASE_URL ||
      !SUPABASE_ANON_KEY ||
      SUPABASE_URL.includes("SEU-PROJETO") ||
      SUPABASE_ANON_KEY.includes("SUA_ANON_KEY");

    if (missingConfig) {
      document.body.insertAdjacentHTML(
        "afterbegin",
        `<div class="container pt-3"><div class="alert alert-danger mb-0">Configure <code>supabase-config.js</code> com <code>url</code> e <code>anonKey</code> do Supabase.</div></div>`
      );
      throw new Error("Supabase não configurado.");
    }

    // Workaround para lock do navegador em alguns ambientes (Vercel/browser)
    const noOpLock = async (_name, _timeout, fn) => await fn();

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        lock: noOpLock,
      },
    });

    const loginCard = document.getElementById("loginCard");
    const adminArea = document.getElementById("adminArea");
    const logoutBtn = document.getElementById("logoutBtn");

    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");

    const giftId = document.getElementById("giftId");
    const classification_id = document.getElementById("classification_id");
    const title = document.getElementById("title");
    const description = document.getElementById("description");
    const image_url = document.getElementById("image_url");
    const buy_url = document.getElementById("buy_url");
    const price_value = document.getElementById("price_value");
    const detectPriceBtn = document.getElementById("detectPriceBtn");
    const qty_total = document.getElementById("qty_total");
    const saveGiftBtn = document.getElementById("saveGiftBtn");
    const clearBtn = document.getElementById("clearBtn");
    const adminMsg = document.getElementById("adminMsg");

    const className = document.getElementById("className");
    const saveClassBtn = document.getElementById("saveClassBtn");
    const classMsg = document.getElementById("classMsg");
    const classTbody = document.getElementById("classTbody");

    const giftsTbody = document.getElementById("giftsTbody");
    const resTbody = document.getElementById("resTbody");
    const refreshBtn = document.getElementById("refreshBtn");
    const resMsg = document.getElementById("resMsg");
    const instructionsEditor = document.getElementById("instructionsEditor");
    const saveInstructionsBtn = document.getElementById("saveInstructionsBtn");
    const instructionsMsg = document.getElementById("instructionsMsg");
    const addLinkBtn = document.getElementById("addLinkBtn");

    function formatError(err) {
      const msg = String(err?.message || err || "Erro inesperado");
      if (msg.includes("row-level security")) {
        return "Permissão negada (RLS). Verifique se seu email está em admin_emails.";
      }
      if (msg.toLowerCase().includes("invalid login credentials")) {
        return "Email ou senha inválidos.";
      }
      if (msg.toLowerCase().includes("email not confirmed")) {
        return "Email não confirmado no Supabase Auth.";
      }
      return msg;
    }

    const upper = (s) => String(s ?? "").trim().toLocaleUpperCase("pt-BR");
    const formatBRL = (v) => (v === null || v === undefined || v === "")
      ? "-"
      : new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(Number(v));

    function parsePriceInput(value) {
      const raw = String(value ?? "").trim();
      if (!raw) return null;

      const only = raw.replace(/[^\d,.-]/g, "");
      const br = Number(only.replace(/\./g, "").replace(",", "."));
      if (Number.isFinite(br) && br >= 0) return Math.round(br * 100) / 100;

      const en = Number(only.replace(/,/g, ""));
      if (Number.isFinite(en) && en >= 0) return Math.round(en * 100) / 100;

      return null;
    }

    function extractPriceFromText(text) {
      const patterns = [
        /R\$\s*([0-9]{1,3}(?:\.[0-9]{3})*,[0-9]{2})/g,
        /R\$\s*([0-9]+,[0-9]{2})/g,
        /R\$\s*([0-9]+(?:\.[0-9]{2}))/g,
      ];

      for (const re of patterns) {
        const m = re.exec(text);
        re.lastIndex = 0;
        if (m?.[1]) {
          const parsed = parsePriceInput(m[1]);
          if (parsed !== null) return parsed;
        }
      }
      return null;
    }

    async function fetchTextWithTimeout(url, ms = 10000) {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), ms);
      try {
        const res = await fetch(url, { signal: controller.signal });
        if (!res.ok) return null;
        return await res.text();
      } catch {
        return null;
      } finally {
        clearTimeout(t);
      }
    }

    async function detectPriceFromUrl(url) {
      const raw = String(url ?? "").trim();
      if (!raw) return null;

      let parsedUrl;
      try { parsedUrl = new URL(raw); } catch { return null; }
      const noScheme = parsedUrl.href.replace(/^https?:\/\//i, "");

      const candidates = [
        parsedUrl.href,
        `https://r.jina.ai/http://${noScheme}`,
      ];

      for (const u of candidates) {
        const text = await fetchTextWithTimeout(u, 10000);
        if (!text) continue;
        const price = extractPriceFromText(text);
        if (price !== null) return price;
      }
      return null;
    }

    function applyEditorFormat(cmd) {
      instructionsEditor.focus();
      if (cmd === "h3") {
        document.execCommand("formatBlock", false, "h3");
      } else {
        document.execCommand(cmd, false, null);
      }
    }

    const esc = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[c]));

    let classifications = [];

    function renderClassificationOptions(selected = "") {
      classification_id.innerHTML = `<option value="">Sem classificação</option>` +
        classifications.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join("");

      if (selected !== "" && selected !== null && selected !== undefined) {
        classification_id.value = String(selected);
      } else {
        classification_id.value = "";
      }
    }

    function renderClassificationTable() {
      classTbody.innerHTML = classifications.map(c => `
        <tr>
          <td>${esc(c.name)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger" data-del-class="${c.id}">Remover</button>
          </td>
        </tr>
      `).join("");

      classTbody.querySelectorAll("button[data-del-class]").forEach(btn => {
        btn.onclick = async () => {
          const id = Number(btn.getAttribute("data-del-class"));
          if (!confirm("Remover esta classificação?")) return;

          const { error } = await supabase.from("gift_classifications").delete().eq("id", id);
          if (error) {
            classMsg.textContent = "Erro ao remover classificação: " + formatError(error);
            return;
          }
          classMsg.textContent = "Classificação removida.";
          await loadAdminData();
        };
      });
    }

    document.querySelectorAll("[data-format]").forEach(btn => {
      btn.addEventListener("click", () => {
        const cmd = btn.getAttribute("data-format");
        if (cmd) applyEditorFormat(cmd);
      });
    });

    addLinkBtn.addEventListener("click", () => {
      const url = prompt("Informe a URL do link:");
      if (!url) return;
      instructionsEditor.focus();
      document.execCommand("createLink", false, url.trim());
    });

    async function ensureAdminPermission() {
      const { data, error } = await supabase.rpc("is_admin");
      if (error) throw error;
      return data === true;
    }

    function setLoggedIn(logged) {
      loginCard.classList.toggle("d-none", logged);
      adminArea.classList.toggle("d-none", !logged);
      logoutBtn.classList.toggle("d-none", !logged);
    }

    function clearForm() {
      giftId.value = "";
      classification_id.value = "";
      title.value = "";
      description.value = "";
      image_url.value = "";
      buy_url.value = "";
      price_value.value = "";
      qty_total.value = 1;
      adminMsg.textContent = "";
    }

    async function loadAdminData() {
      const { data: site, error: es } = await supabase
        .from("site_content")
        .select("id,instructions_html")
        .eq("id", 1)
        .maybeSingle();

      if (es) throw es;
      instructionsEditor.innerHTML = site?.instructions_html || "";

      const { data: cls, error: ec } = await supabase
        .from("gift_classifications")
        .select("id,name")
        .order("name", { ascending: true });

      if (ec) throw ec;
      classifications = cls ?? [];
      renderClassificationOptions();
      renderClassificationTable();

      // gifts_view
      const { data: gifts, error: eg } = await supabase
        .from("gifts_view")
        .select("id,title,price_value,classification_id,classification_name,qty_total,qty_reserved,qty_available")
        .order("id", { ascending: true });

      if (eg) throw eg;

      giftsTbody.innerHTML = gifts.map(g => `
        <tr>
          <td>${g.id}</td>
          <td>${upper(g.title)}</td>
          <td>${g.classification_name ?? "-"}</td>
          <td>${formatBRL(g.price_value)}</td>
          <td>${g.qty_total}</td>
          <td>${g.qty_reserved}</td>
          <td>${g.qty_available}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-secondary" data-edit="${g.id}">Editar</button>
          </td>
        </tr>
      `).join("");

      giftsTbody.querySelectorAll("button[data-edit]").forEach(btn => {
        btn.onclick = async () => {
          const id = Number(btn.getAttribute("data-edit"));
          const { data, error } = await supabase.from("gifts").select("*").eq("id", id).single();
          if (error) return;
          giftId.value = data.id;
          title.value = upper(data.title);
          description.value = data.description ?? "";
          image_url.value = data.image_url ?? "";
          buy_url.value = data.buy_url ?? "";
          price_value.value = data.price_value === null || data.price_value === undefined ? "" : String(data.price_value);
          qty_total.value = data.qty_total ?? 1;
          renderClassificationOptions(data.classification_id ?? "");
          adminMsg.textContent = `Editando presente #${data.id}`;
        };
      });

      // reservas
      const { data: res, error: er } = await supabase
        .from("gift_reservations")
        .select("id,gift_id,reserved_by,qty,reserved_at,gifts(title)")
        .order("reserved_at", { ascending: false })
        .limit(200);

      if (er) throw er;

      resTbody.innerHTML = res.map(r => `
        <tr>
          <td>${r.gifts?.title ?? ("#" + r.gift_id)}</td>
          <td>${r.reserved_by}</td>
          <td>${r.qty}</td>
          <td>${new Date(r.reserved_at).toLocaleString("pt-BR")}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger" data-del="${r.id}">Remover</button>
          </td>
        </tr>
      `).join("");

      resTbody.querySelectorAll("button[data-del]").forEach(btn => {
        btn.onclick = async () => {
          const id = Number(btn.getAttribute("data-del"));
          if (!confirm("Remover esta reserva?")) return;
          const { error } = await supabase.from("gift_reservations").delete().eq("id", id);
          if (error) {
            resMsg.textContent = "Erro ao remover: " + error.message;
          } else {
            resMsg.textContent = "Reserva removida.";
            await loadAdminData();
          }
        };
      });

      resMsg.textContent = `Mostrando até 200 reservas recentes.`;
    }

    loginBtn.onclick = async () => {
      loginBtn.disabled = true;
      loginMsg.textContent = "Entrando...";
      try {
        const { error } = await supabase.auth.signInWithPassword({
          email: email.value.trim(),
          password: password.value
        });
        if (error) {
          loginMsg.textContent = "Erro: " + formatError(error);
          return;
        }
        loginMsg.textContent = "Login realizado. Validando acesso...";
      } catch (e) {
        loginMsg.textContent = "Erro: " + formatError(e);
      } finally {
        loginBtn.disabled = false;
      }
    };

    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      setLoggedIn(false);
      clearForm();
    };

    saveClassBtn.onclick = async () => {
      saveClassBtn.disabled = true;
      classMsg.textContent = "Salvando classificação...";

      const name = className.value.trim();
      if (name.length < 2) {
        classMsg.textContent = "Informe um nome de classificação com pelo menos 2 caracteres.";
        saveClassBtn.disabled = false;
        return;
      }

      try {
        const { error } = await supabase.from("gift_classifications").insert({ name });
        if (error) throw error;
        className.value = "";
        classMsg.textContent = "Classificação criada.";
        await loadAdminData();
      } catch (e) {
        classMsg.textContent = "Erro ao criar classificação: " + formatError(e);
      } finally {
        saveClassBtn.disabled = false;
      }
    };

    saveInstructionsBtn.onclick = async () => {
      saveInstructionsBtn.disabled = true;
      instructionsMsg.textContent = "Salvando mensagem...";
      try {
        const payload = {
          id: 1,
          instructions_html: instructionsEditor.innerHTML || "",
        };
        const { error } = await supabase.from("site_content").upsert(payload, { onConflict: "id" });
        if (error) throw error;
        instructionsMsg.textContent = "Mensagem salva.";
      } catch (e) {
        instructionsMsg.textContent = "Erro ao salvar mensagem: " + formatError(e);
      } finally {
        saveInstructionsBtn.disabled = false;
      }
    };

    detectPriceBtn.onclick = async () => {
      detectPriceBtn.disabled = true;
      adminMsg.textContent = "Buscando valor no link...";
      try {
        const detected = await detectPriceFromUrl(buy_url.value);
        if (detected === null) {
          adminMsg.textContent = "Não foi possível identificar o valor neste link.";
        } else {
          price_value.value = String(detected.toFixed(2));
          adminMsg.textContent = `Valor detectado: ${formatBRL(detected)}.`;
        }
      } catch (e) {
        adminMsg.textContent = "Erro ao capturar valor: " + formatError(e);
      } finally {
        detectPriceBtn.disabled = false;
      }
    };

    buy_url.addEventListener("blur", async () => {
      if (!buy_url.value.trim() || price_value.value.trim()) return;
      try {
        const detected = await detectPriceFromUrl(buy_url.value);
        if (detected !== null) price_value.value = String(detected.toFixed(2));
      } catch {
        // Falha silenciosa no blur para não interromper o fluxo do formulário.
      }
    });

    saveGiftBtn.onclick = async () => {
      saveGiftBtn.disabled = true;
      adminMsg.textContent = "Salvando...";
      const classIdNum = Number(classification_id.value);
      let priceNum = parsePriceInput(price_value.value);
      try {
        if (priceNum === null && buy_url.value.trim()) {
          priceNum = await detectPriceFromUrl(buy_url.value);
          if (priceNum !== null) price_value.value = String(priceNum.toFixed(2));
        }
      } catch {
        // Continua salvando mesmo se não conseguir detectar valor automaticamente.
      }
      const payload = {
        classification_id: Number.isInteger(classIdNum) && classIdNum > 0 ? classIdNum : null,
        title: upper(title.value),
        description: description.value.trim() || null,
        image_url: image_url.value.trim() || null,
        buy_url: buy_url.value.trim() || null,
        price_value: priceNum,
        qty_total: Number(qty_total.value || 1)
      };

      if (!payload.title) {
        adminMsg.textContent = "Informe o título.";
        saveGiftBtn.disabled = false;
        return;
      }
      if (!Number.isInteger(payload.qty_total) || payload.qty_total < 1) {
        adminMsg.textContent = "Quantidade total inválida.";
        saveGiftBtn.disabled = false;
        return;
      }

      try {
        if (giftId.value) {
          const { error } = await supabase.from("gifts").update(payload).eq("id", Number(giftId.value));
          if (error) throw error;
          adminMsg.textContent = "Atualizado.";
        } else {
          const { error } = await supabase.from("gifts").insert(payload);
          if (error) throw error;
          adminMsg.textContent = "Criado.";
        }

        try {
          await loadAdminData();
        } catch (e) {
          adminMsg.textContent = "Salvou, mas falhou ao recarregar: " + formatError(e);
        }
      } catch (e) {
        adminMsg.textContent = "Erro ao salvar: " + formatError(e);
      } finally {
        saveGiftBtn.disabled = false;
      }
    };

    clearBtn.onclick = clearForm;
    refreshBtn.onclick = async () => {
      try {
        await loadAdminData();
      } catch (e) {
        resMsg.textContent = "Erro ao atualizar: " + formatError(e);
      }
    };

    // on load: checa sessão
    const { data: { session } } = await supabase.auth.getSession();
    setLoggedIn(!!session);

    async function handleSessionChange(session2) {
      if (!session2) {
        setLoggedIn(false);
        return;
      }
      try {
        const isAdmin = await ensureAdminPermission();
        setLoggedIn(isAdmin);
        if (!isAdmin) {
          loginMsg.textContent = "Login OK, mas este usuário não está autorizado no admin.";
          await supabase.auth.signOut();
          return;
        }
        loginMsg.textContent = "";
        await loadAdminData();
      } catch (e) {
        setLoggedIn(false);
        resMsg.textContent = "Erro ao carregar dados: " + formatError(e);
        loginMsg.textContent = "Erro ao validar admin: " + formatError(e);
      }
    }

    // Evita chamadas async diretas dentro do callback de auth
    supabase.auth.onAuthStateChange((_event, session2) => {
      setTimeout(() => {
        handleSessionChange(session2);
      }, 0);
    });

    if (session) await handleSessionChange(session);
  </script>
</body>
</html>


