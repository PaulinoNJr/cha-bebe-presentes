<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Chá da Melissa (Mel)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/minty/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --mel-bg: #fff9ef;
      --mel-accent: #f0a500;
      --mel-accent-dark: #c78200;
    }
    body {
      background:
        radial-gradient(circle at top right, #fff4da 0%, transparent 45%),
        radial-gradient(circle at bottom left, #ffe8bc 0%, transparent 42%),
        var(--mel-bg);
    }
    h1 { color: #8f5b00; }
    .card { border: 1px solid #f4d79e; }
    .btn-primary {
      background-color: var(--mel-accent);
      border-color: var(--mel-accent);
    }
    .btn-primary:hover {
      background-color: var(--mel-accent-dark);
      border-color: var(--mel-accent-dark);
    }
    .btn-outline-primary {
      color: #8f5b00;
      border-color: #dbad4d;
    }
    .btn-outline-primary:hover {
      color: #fff;
      background: #c28718;
      border-color: #c28718;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 mb-0">Admin - Chá da Melissa (Mel)</h1>
      <div class="d-flex gap-2">
        <a href="./index.html" class="btn btn-outline-primary btn-sm">Ver lista</a>
        <button id="logoutBtn" class="btn btn-outline-secondary btn-sm d-none">Sair</button>
      </div>
    </div>

    <!-- Login -->
    <div id="loginCard" class="card shadow-sm">
      <div class="card-body">
        <h2 class="h6">Login</h2>
        <div class="row g-2">
          <div class="col-md-5">
            <input id="email" class="form-control" placeholder="Email" />
          </div>
          <div class="col-md-5">
            <input id="password" class="form-control" type="password" placeholder="Senha" />
          </div>
          <div class="col-md-2 d-grid">
            <button id="loginBtn" class="btn btn-primary">Entrar</button>
          </div>
        </div>
        <div id="loginMsg" class="small text-muted mt-2"></div>
      </div>
    </div>

    <!-- Admin -->
    <div id="adminArea" class="d-none">
      <div class="row g-3 mt-1">
        <div class="col-lg-5">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6">Novo/Editar Presente</h2>

              <input type="hidden" id="giftId">

              <div class="mb-2">
                <label class="form-label">Título</label>
                <input id="title" class="form-control" placeholder="Ex: Fralda P" />
              </div>

              <div class="mb-2">
                <label class="form-label">Descrição</label>
                <textarea id="description" class="form-control" rows="2"></textarea>
              </div>

              <div class="mb-2">
                <label class="form-label">Imagem (URL)</label>
                <input id="image_url" class="form-control" placeholder="https://..." />
              </div>

              <div class="mb-2">
                <label class="form-label">Link compra (URL)</label>
                <input id="buy_url" class="form-control" placeholder="https://..." />
              </div>

              <div class="mb-3">
                <label class="form-label">Quantidade total</label>
                <input id="qty_total" class="form-control" type="number" min="1" value="1" />
              </div>

              <div class="d-flex gap-2">
                <button id="saveGiftBtn" class="btn btn-primary">Salvar</button>
                <button id="clearBtn" class="btn btn-outline-secondary">Limpar</button>
              </div>

              <div id="adminMsg" class="small text-muted mt-2"></div>
            </div>
          </div>
        </div>

        <div class="col-lg-7">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h2 class="h6 mb-0">Presentes</h2>
                <button id="refreshBtn" class="btn btn-outline-primary btn-sm">Atualizar</button>
              </div>

              <div class="table-responsive mt-3">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Título</th>
                      <th>Total</th>
                      <th>Reservado</th>
                      <th>Disponível</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="giftsTbody"></tbody>
                </table>
              </div>

              <hr />

              <h3 class="h6">Reservas (para correção)</h3>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Presente</th>
                      <th>Nome</th>
                      <th>Qtd</th>
                      <th>Data</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="resTbody"></tbody>
                </table>
              </div>

              <div id="resMsg" class="small text-muted"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="./supabase-config.js"></script>

  <!-- supabase-js via ESM CDN -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const cfg = window.SUPABASE_CONFIG || {};
    const SUPABASE_URL = cfg.url;
    const SUPABASE_ANON_KEY = cfg.anonKey;

    const missingConfig =
      !SUPABASE_URL ||
      !SUPABASE_ANON_KEY ||
      SUPABASE_URL.includes("SEU-PROJETO") ||
      SUPABASE_ANON_KEY.includes("SUA_ANON_KEY");

    if (missingConfig) {
      document.body.insertAdjacentHTML(
        "afterbegin",
        `<div class="container pt-3"><div class="alert alert-danger mb-0">Configure <code>supabase-config.js</code> com <code>url</code> e <code>anonKey</code> do Supabase.</div></div>`
      );
      throw new Error("Supabase não configurado.");
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const loginCard = document.getElementById("loginCard");
    const adminArea = document.getElementById("adminArea");
    const logoutBtn = document.getElementById("logoutBtn");

    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");

    const giftId = document.getElementById("giftId");
    const title = document.getElementById("title");
    const description = document.getElementById("description");
    const image_url = document.getElementById("image_url");
    const buy_url = document.getElementById("buy_url");
    const qty_total = document.getElementById("qty_total");
    const saveGiftBtn = document.getElementById("saveGiftBtn");
    const clearBtn = document.getElementById("clearBtn");
    const adminMsg = document.getElementById("adminMsg");

    const giftsTbody = document.getElementById("giftsTbody");
    const resTbody = document.getElementById("resTbody");
    const refreshBtn = document.getElementById("refreshBtn");
    const resMsg = document.getElementById("resMsg");

    function formatError(err) {
      const msg = String(err?.message || err || "Erro inesperado");
      if (msg.includes("row-level security")) {
        return "Permissão negada (RLS). Verifique se seu email está em admin_emails.";
      }
      if (msg.toLowerCase().includes("invalid login credentials")) {
        return "Email ou senha inválidos.";
      }
      if (msg.toLowerCase().includes("email not confirmed")) {
        return "Email não confirmado no Supabase Auth.";
      }
      return msg;
    }

    async function ensureAdminPermission() {
      const { data, error } = await supabase.rpc("is_admin");
      if (error) throw error;
      return data === true;
    }

    function setLoggedIn(logged) {
      loginCard.classList.toggle("d-none", logged);
      adminArea.classList.toggle("d-none", !logged);
      logoutBtn.classList.toggle("d-none", !logged);
    }

    function clearForm() {
      giftId.value = "";
      title.value = "";
      description.value = "";
      image_url.value = "";
      buy_url.value = "";
      qty_total.value = 1;
      adminMsg.textContent = "";
    }

    async function loadAdminData() {
      // gifts_view
      const { data: gifts, error: eg } = await supabase
        .from("gifts_view")
        .select("id,title,qty_total,qty_reserved,qty_available")
        .order("id", { ascending: true });

      if (eg) throw eg;

      giftsTbody.innerHTML = gifts.map(g => `
        <tr>
          <td>${g.id}</td>
          <td>${g.title}</td>
          <td>${g.qty_total}</td>
          <td>${g.qty_reserved}</td>
          <td>${g.qty_available}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-secondary" data-edit="${g.id}">Editar</button>
          </td>
        </tr>
      `).join("");

      giftsTbody.querySelectorAll("button[data-edit]").forEach(btn => {
        btn.onclick = async () => {
          const id = Number(btn.getAttribute("data-edit"));
          const { data, error } = await supabase.from("gifts").select("*").eq("id", id).single();
          if (error) return;
          giftId.value = data.id;
          title.value = data.title ?? "";
          description.value = data.description ?? "";
          image_url.value = data.image_url ?? "";
          buy_url.value = data.buy_url ?? "";
          qty_total.value = data.qty_total ?? 1;
          adminMsg.textContent = `Editando presente #${data.id}`;
        };
      });

      // reservas
      const { data: res, error: er } = await supabase
        .from("gift_reservations")
        .select("id,gift_id,reserved_by,qty,reserved_at,gifts(title)")
        .order("reserved_at", { ascending: false })
        .limit(200);

      if (er) throw er;

      resTbody.innerHTML = res.map(r => `
        <tr>
          <td>${r.gifts?.title ?? ("#" + r.gift_id)}</td>
          <td>${r.reserved_by}</td>
          <td>${r.qty}</td>
          <td>${new Date(r.reserved_at).toLocaleString("pt-BR")}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger" data-del="${r.id}">Remover</button>
          </td>
        </tr>
      `).join("");

      resTbody.querySelectorAll("button[data-del]").forEach(btn => {
        btn.onclick = async () => {
          const id = Number(btn.getAttribute("data-del"));
          if (!confirm("Remover esta reserva?")) return;
          const { error } = await supabase.from("gift_reservations").delete().eq("id", id);
          if (error) {
            resMsg.textContent = "Erro ao remover: " + error.message;
          } else {
            resMsg.textContent = "Reserva removida.";
            await loadAdminData();
          }
        };
      });

      resMsg.textContent = `Mostrando até 200 reservas recentes.`;
    }

    loginBtn.onclick = async () => {
      loginBtn.disabled = true;
      loginMsg.textContent = "Entrando...";
      try {
        const { error } = await supabase.auth.signInWithPassword({
          email: email.value.trim(),
          password: password.value
        });
        if (error) {
          loginMsg.textContent = "Erro: " + formatError(error);
          return;
        }

        const isAdmin = await ensureAdminPermission();
        if (!isAdmin) {
          await supabase.auth.signOut();
          loginMsg.textContent = "Login OK, mas este usuário não está autorizado no admin.";
          return;
        }

        loginMsg.textContent = "";
      } catch (e) {
        loginMsg.textContent = "Erro: " + formatError(e);
      } finally {
        loginBtn.disabled = false;
      }
    };

    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      setLoggedIn(false);
      clearForm();
    };

    saveGiftBtn.onclick = async () => {
      saveGiftBtn.disabled = true;
      adminMsg.textContent = "Salvando...";
      const payload = {
        title: title.value.trim(),
        description: description.value.trim() || null,
        image_url: image_url.value.trim() || null,
        buy_url: buy_url.value.trim() || null,
        qty_total: Number(qty_total.value || 1)
      };

      if (!payload.title) {
        adminMsg.textContent = "Informe o título.";
        saveGiftBtn.disabled = false;
        return;
      }
      if (!Number.isInteger(payload.qty_total) || payload.qty_total < 1) {
        adminMsg.textContent = "Quantidade total inválida.";
        saveGiftBtn.disabled = false;
        return;
      }

      try {
        if (giftId.value) {
          const { error } = await supabase.from("gifts").update(payload).eq("id", Number(giftId.value));
          if (error) throw error;
          adminMsg.textContent = "Atualizado.";
        } else {
          const { error } = await supabase.from("gifts").insert(payload);
          if (error) throw error;
          adminMsg.textContent = "Criado.";
        }

        try {
          await loadAdminData();
        } catch (e) {
          adminMsg.textContent = "Salvou, mas falhou ao recarregar: " + formatError(e);
        }
      } catch (e) {
        adminMsg.textContent = "Erro ao salvar: " + formatError(e);
      } finally {
        saveGiftBtn.disabled = false;
      }
    };

    clearBtn.onclick = clearForm;
    refreshBtn.onclick = async () => {
      try {
        await loadAdminData();
      } catch (e) {
        resMsg.textContent = "Erro ao atualizar: " + formatError(e);
      }
    };

    // on load: checa sessão
    const { data: { session } } = await supabase.auth.getSession();
    setLoggedIn(!!session);

    supabase.auth.onAuthStateChange(async (_event, session2) => {
      if (!session2) {
        setLoggedIn(false);
        return;
      }
      try {
        const isAdmin = await ensureAdminPermission();
        setLoggedIn(isAdmin);
        if (!isAdmin) {
          loginMsg.textContent = "Usuário sem permissão de admin.";
          await supabase.auth.signOut();
          return;
        }
        await loadAdminData();
      } catch (e) {
        setLoggedIn(false);
        resMsg.textContent = "Erro ao carregar dados: " + formatError(e);
        loginMsg.textContent = "Erro ao validar admin: " + formatError(e);
      }
    });

    if (session) {
      try {
        const isAdmin = await ensureAdminPermission();
        setLoggedIn(isAdmin);
        if (!isAdmin) {
          loginMsg.textContent = "Usuário sem permissão de admin.";
          await supabase.auth.signOut();
        } else {
          await loadAdminData();
        }
      } catch (e) {
        setLoggedIn(false);
        resMsg.textContent = "Erro ao carregar dados: " + formatError(e);
      }
    }
  </script>
</body>
</html>


